name: "üß™ Auto Test Generator"

on:
  pull_request:
    types: [labeled]
  workflow_dispatch:
    inputs:
      target_class:
        description: 'Specific class to generate tests for (optional)'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-tests:
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'pull_request' && github.event.label.name == 'generate-tests')
    
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: "üîß Setup Environment"
        run: |
          npm install -g @salesforce/cli
          curl -fsSL https://cursor.com/install | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH
          
      - name: "üîç Find Classes Without Tests"
        id: find-classes
        run: |
          echo "Scanning for classes without tests..."
          
          CLASSES_WITHOUT_TESTS=""
          
          # Find all Apex classes (excluding test classes)
          for class_file in $(find force-app -name "*.cls" ! -name "*Test.cls" -type f); do
            class_name=$(basename "$class_file" .cls)
            test_file="${class_file%/*}/${class_name}Test.cls"
            
            if [ ! -f "$test_file" ]; then
              CLASSES_WITHOUT_TESTS="$CLASSES_WITHOUT_TESTS$class_file\n"
              echo "‚ùå Missing test: $class_name"
            else
              echo "‚úÖ Has test: $class_name"
            fi
          done
          
          echo "classes<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CLASSES_WITHOUT_TESTS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          if [ -z "$CLASSES_WITHOUT_TESTS" ]; then
            echo "has_missing_tests=false" >> $GITHUB_OUTPUT
          else
            echo "has_missing_tests=true" >> $GITHUB_OUTPUT
          fi
          
      - name: "ü§ñ Generate Test Classes"
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        shell: bash
        run: |
          set -euo pipefail
          echo "ü§ñ Generating test classes with Cursor AI..."
          
          CLASSES="${{ steps.find-classes.outputs.classes }}"
          GENERATED_COUNT=0
          
          # Iterate over classes and generate tests
          while IFS= read -r class_file; do
            if [ -z "$class_file" ] || [ ! -f "$class_file" ]; then
              continue
            fi
            class_name="$(basename "$class_file" .cls)"
            test_file="${class_file%/*}/${class_name}Test.cls"
            test_meta="${class_file%/*}/${class_name}Test.cls-meta.xml"
            echo "Generating test for: $class_name"
            CLASS_CONTENT="$(cat "$class_file")"
            
            # Build prompt content safely using command substitution to avoid YAML implicit key parsing issues
            PROMPT_CONTENT=$(cat <<'PROMPT_END'
You are an expert Salesforce test developer. Generate a comprehensive Apex test class for the following Salesforce class.

CLASS TO TEST: __CLASS_NAME__

SOURCE CODE:
<APEX_CODE_BLOCK>
__CLASS_CONTENT__
</APEX_CODE_BLOCK>

REQUIREMENTS:
1. Test class name must be exactly: __CLASS_NAME__Test
2. Use @isTest annotation at class level
3. Include @TestSetup method to create test data if needed
4. Cover ALL public and global methods
5. Include positive test scenarios
6. Include negative test scenarios (error handling)
7. Include bulk test scenarios (200 records)
8. Use Test.startTest() and Test.stopTest() appropriately
9. Use System.assert, System.assertEquals with descriptive messages
10. Mock any external callouts using Test.setMock()
11. Aim for 100% code coverage
12. Follow Salesforce best practices
13. Add JSDoc comments explaining each test method

OUTPUT FORMAT:
- Provide ONLY the complete Apex test class code
- No explanations or markdown formatting
- Start with /** class comment */ and end with final }
- Include all necessary imports and annotations
PROMPT_END
)
            printf '%s' "$PROMPT_CONTENT" > prompt.txt

            # Substitute placeholders safely
            # Escape backslashes, slashes and ampersands for sed (corrected character class)
            ESCAPED_CLASS_CONTENT=$(printf '%s' "$CLASS_CONTENT" | sed -e 's/[&\/\\]/\\&/g')
            sed -e "s/__CLASS_NAME__/$class_name/g" -e "s/__CLASS_CONTENT__/$ESCAPED_CLASS_CONTENT/g" prompt.txt > prompt-final.txt
            
            # Generate test class
            cursor-agent -m gpt-4 < prompt-final.txt > "$test_file" 2>/dev/null
            
            # Verify the file was created and has content
            if [ -s "$test_file" ]; then
              # Create meta.xml file
              cat > "$test_meta" <<'META_EOF'
<?xml version="1.0" encoding="UTF-8"?>
<ApexClass xmlns="http://soap.sforce.com/2006/04/metadata">
    <apiVersion>60.0</apiVersion>
    <status>Active</status>
</ApexClass>
META_EOF
              echo "‚úÖ Generated: $test_file"
              GENERATED_COUNT=$((GENERATED_COUNT + 1))
            else
              echo "‚ùå Failed to generate: $test_file"
              rm -f "$test_file"
            fi
          done <<< "${{ steps.find-classes.outputs.classes }}"
          
          echo "GENERATED_COUNT=$GENERATED_COUNT" >> $GITHUB_ENV
          
      - name: "üîç Validate Generated Tests"
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        run: |
          echo "üîç Validating generated test classes..."
          
          # Check syntax of generated tests
          for test_file in $(find force-app -name "*Test.cls" -type f); do
            if [ -f "$test_file" ]; then
              # Basic validation - check for required elements
              if grep -q "@isTest" "$test_file" && grep -q "class" "$test_file"; then
                echo "‚úÖ Valid syntax: $(basename $test_file)"
              else
                echo "‚ö†Ô∏è  Potential issues: $(basename $test_file)"
              fi
            fi
          done
          
      - name: "üìä Generate Test Report"
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        run: |
          {
            echo "# üß™ Test Generation Report"
            echo
            echo "## Summary"
            echo "- Tests Generated: ${{ env.GENERATED_COUNT }}"
            echo "- Timestamp: $(date)"
            echo "- Triggered By: ${{ github.actor }}"
            echo
            echo "## Generated Test Classes"
            echo
          } > test-generation-report.md
          
          for test_file in $(find force-app -name "*Test.cls" -type f -newer .git); do
            if [ -f "$test_file" ]; then
              test_name=$(basename "$test_file" .cls)
              lines=$(wc -l < "$test_file")
              echo "- $test_name ($lines lines)" >> test-generation-report.md
            fi
          done
          
          {
            echo
            echo "## Next Steps"
            echo
            echo "1. Review Generated Tests: Carefully review each generated test class"
            echo "2. Validate Logic: Ensure test assertions match expected behavior"
            echo "3. Run Tests: Execute tests in your Salesforce org"
            echo "4. Check Coverage: Verify code coverage meets requirements (85%+)"
            echo "5. Refine: Adjust tests as needed for your specific use cases"
            echo
            echo "## Important Notes"
            echo
            echo "AI-generated tests should always be reviewed by a human before deployment"
            echo "- Verify test data setup is appropriate"
            echo "- Ensure assertions validate correct behavior"
            echo "- Check for any security or privacy concerns"
            echo "- Validate bulk processing scenarios"
            echo
            echo "Generated by Cursor AI Test Generator"
          } >> test-generation-report.md
          
      - name: "üíæ Commit Generated Tests"
        if: steps.find-classes.outputs.has_missing_tests == 'true'
        run: |
          git config user.name "Cursor AI Bot"
          git config user.email "cursor-ai@github-actions"
          
          git add force-app/**/*Test.cls*
          git add test-generation-report.md
          
          if git diff --staged --quiet; then
            echo "No tests to commit"
          else
            git commit -m "ü§ñ Auto-generate test classes via Cursor AI

Generated ${{ env.GENERATED_COUNT }} test classes
            
Co-authored-by: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>"
            
            git push
            echo "‚úÖ Tests committed and pushed"
          fi
          
      - name: "üí¨ Post Results Comment"
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
       let comment = '';
            
            if (fs.existsSync('test-generation-report.md')) {
              comment = fs.readFileSync('test-generation-report.md', 'utf8');
            } else if ('${{ steps.find-classes.outputs.has_missing_tests }}' === 'false') {
              comment = '‚úÖ **All classes already have test coverage!**\\n\\nNo test generation needed.';
            } else {
              comment = '‚ùå **Test generation failed**\\n\\nPlease check the workflow logs for details.';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            })
      - name: "üì§ Upload Artifacts"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-tests
          path: |
            force-app/**/*Test.cls
            test-generation-report.md
          retention-days: 30

name: Test AI Integration

on:
  workflow_dispatch:
    inputs:
      provider:
        description: "AI Provider"
        required: true
        default: "anthropic"
        type: choice
        options:
          - anthropic
          - openai
      test_file:
        description: "Path to test Apex file (optional)"
        required: false
        type: string

jobs:
  test-ai-code-review:
    name: Test AI Code Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq bc
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Create test Apex file (if not provided)
        if: ${{ inputs.test_file == '' }}
        run: |
          mkdir -p test-classes
          cat > test-classes/AccountService.cls << 'EOF'
          public class AccountService {
              public static List<Account> getAccounts(String searchTerm) {
                  // ISSUE: SOQL injection vulnerability
                  String query = 'SELECT Id, Name FROM Account WHERE Name LIKE \'%' + searchTerm + '%\'';
                  return Database.query(query);
              }
              
              public static void updateAccounts(List<Account> accounts) {
                  // ISSUE: No CRUD/FLS check
                  for(Account acc : accounts) {
                      // ISSUE: DML in loop
                      update acc;
                  }
              }
              
              public static Account createAccount(String name) {
                  Account acc = new Account(Name = name);
                  insert acc;
                  return acc;
              }
          }
          EOF
          echo "test-classes/AccountService.cls" > files-to-review.txt

      - name: Use provided test file
        if: ${{ inputs.test_file != '' }}
        run: |
          echo "${{ inputs.test_file }}" > files-to-review.txt

      - name: Display files to review
        run: |
          echo "Files to review:"
          cat files-to-review.txt

      - name: Run AI Code Review (Anthropic)
        if: ${{ inputs.provider == 'anthropic' }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          AI_PROVIDER: anthropic
        run: |
          chmod +x .github/scripts/ai-code-review.sh
          chmod +x .github/scripts/lib/ai-client.sh
          ./.github/scripts/ai-code-review.sh files-to-review.txt || true

      - name: Run AI Code Review (OpenAI)
        if: ${{ inputs.provider == 'openai' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          AI_PROVIDER: openai
        run: |
          chmod +x .github/scripts/ai-code-review.sh
          chmod +x .github/scripts/lib/ai-client.sh
          ./.github/scripts/ai-code-review.sh files-to-review.txt || true

      - name: Display review results
        if: always()
        run: |
          if [ -f review-results.json ]; then
            echo "════════════════════════════════════════"
            echo "  AI Code Review Results"
            echo "════════════════════════════════════════"
            cat review-results.json | jq '.'
            echo ""
            echo "Summary by file:"
            cat review-results.json | jq -r '.[] | "\(.file_path): Score \(.overall_score)/10, Issues: \(.issues | length)"'
          else
            echo "No review results file found"
          fi

      - name: Display critical and high severity issues
        if: always()
        run: |
          if [ -f review-results.json ]; then
            echo "Critical Issues:"
            cat review-results.json | jq -r '.[] | .issues[] | select(.severity == "critical") | "  [\(.line)] \(.message)"'
            echo ""
            echo "High Severity Issues:"
            cat review-results.json | jq -r '.[] | .issues[] | select(.severity == "high") | "  [\(.line)] \(.message)"'
          fi

      - name: Upload review results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ai-review-results-${{ inputs.provider }}
          path: |
            review-results.json
            review_*.txt
          retention-days: 30

      - name: Test Summary
        if: always()
        run: |
          echo "════════════════════════════════════════"
          echo "  Test Summary"
          echo "════════════════════════════════════════"
          echo "Provider: ${{ inputs.provider }}"
          echo "Status: ✅ Test completed"
          echo ""
          echo "Review the artifacts for detailed results"
          echo "════════════════════════════════════════"

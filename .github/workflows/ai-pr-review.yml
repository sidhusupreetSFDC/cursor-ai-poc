name: "ü§ñ AI Code Review"

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "force-app/**/*.cls"
      - "force-app/**/*.trigger"
      - "force-app/**/*.js"

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-code-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: "üì• Checkout Code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "üîß Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"

      - name: "üì¶ Install Salesforce CLI"
        run: |
          npm install -g @salesforce/cli
          sf version

      - name: "ü§ñ Install Cursor CLI"
        run: |
          curl -fsSL https://cursor.com/install | bash
          echo "$HOME/.cursor/bin" >> $GITHUB_PATH

      - name: "‚úÖ Verify Cursor Installation"
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          cursor-agent --version || echo "Cursor CLI installed"

      - name: "üîç Get Changed Files"
        id: changed-files
        run: |
          echo "Fetching changed files..."
          git fetch origin ${{ github.base_ref }}

          APEX_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep -E '\.(cls|trigger)$' || echo "")
          JS_FILES=$(git diff --name-only origin/${{ github.base_ref }} HEAD | grep -E '\.js$' || echo "")

          {
            echo "apex_files<<EOF"
            echo "$APEX_FILES"
            echo "EOF"
            echo "js_files<<EOF"
            echo "$JS_FILES"
            echo "EOF"
            if [ -z "$APEX_FILES" ] && [ -z "$JS_FILES" ]; then
              echo "has_changes=false"
            else
              echo "has_changes=true"
            fi
          } >> "$GITHUB_OUTPUT"

      - name: "üß† AI Analysis - Apex Code"
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          echo "# ü§ñ Cursor AI Code Review" > review.md
          echo "" >> review.md
          echo "**Generated:** $(date)" >> review.md
          echo "" >> review.md

          APEX_FILES="${{ steps.changed-files.outputs.apex_files }}"

          if [ -n "$APEX_FILES" ]; then
            echo "## üìä Apex Code Analysis" >> review.md
            echo "" >> review.md

            echo "$APEX_FILES" | while IFS= read -r file; do
              if [ -n "$file" ] && [ -f "$file" ]; then
                echo "### üìÑ \`$file\`" >> review.md
                echo "" >> review.md

                # Build prompt using a here-doc safely inside the run block
                FILE_PATH="$file"
                FILE_CONTENT="$(cat "$file")"

                # Build prompt safely using printf to avoid YAML parsing issues
                FILE_PATH="$file"
                FILE_CONTENT="$(cat "$file")"

                {
                  printf '%s\n' "You are an expert Salesforce Apex code reviewer. Analyze this code:"
                  printf '\n'
                  printf '%s\n' "FILE: $FILE_PATH"
                  printf '\n'
                  printf '%s\n' "CODE (Apex):"
                  printf '%s\n' "----- BEGIN CODE -----"
                  printf '%s\n' "$FILE_CONTENT"
                  printf '%s\n' "----- END CODE -----"
                  printf '\n'
                  printf '%s\n' "Provide a detailed review covering:"
                  printf '%s\n' "1) Critical Issues"
                  printf '%s\n' "2) Governor Limits"
                  printf '%s\n' "3) Best Practices"
                  printf '%s\n' "4) Performance"
                  printf '%s\n' "5) Recommendations"
                  printf '\n'
                  printf '%s\n' "Format your response as markdown with clear sections and code examples where helpful."
                } > prompt.final.txt

                cursor-agent -m gpt-4 < prompt.final.txt >> review.md 2>/dev/null || echo "‚ö†Ô∏è *AI analysis unavailable for this file*" >> review.md

                echo "" >> review.md
                echo "---" >> review.md
                echo "" >> review.md
              fi
            done
          fi

      - name: "üìä Generate Complexity Metrics"
        if: steps.changed-files.outputs.has_changes == 'true'
        run: |
          echo "" >> review.md
          echo "## üìà Code Complexity Metrics" >> review.md
          echo "" >> review.md

          APEX_FILES="${{ steps.changed-files.outputs.apex_files }}"

          if [ -n "$APEX_FILES" ]; then
            echo "| File | Lines | Methods | Complexity |" >> review.md
            echo "|------|-------|---------|------------|" >> review.md

            echo "$APEX_FILES" | while IFS= read -r file; do
              if [ -n "$file" ] && [ -f "$file" ]; then
                LINES=$(wc -l < "$file")
                METHODS=$(grep -c "public\|private\|global" "$file" || echo "0")
                echo "| \`$(basename "$file")\` | $LINES | $METHODS | TBD |" >> review.md
              fi
            done
          fi

      - name: "üéØ AI Summary and Action Items"
        if: steps.changed-files.outputs.has_changes == 'true'
        env:
          CURSOR_API_KEY: ${{ secrets.CURSOR_API_KEY }}
        run: |
          echo "" >> review.md
          echo "## üéØ Summary and Action Items" >> review.md
          echo "" >> review.md

          {
            printf '%s\n' "Based on this code review, provide:"
            printf '%s\n' "1) Overall Assessment (1‚Äì10)"
            printf '%s\n' "2) Critical Actions"
            printf '%s\n' "3) Recommended Actions"
            printf '%s\n' "4) Optional Improvements"
            printf '%s\n' "5) Approval Recommendation"
            printf '\n'
            printf '%s\n' "Review content:"
            printf '%s\n' "----- BEGIN REVIEW -----"
            cat review.md
            printf '%s\n' "----- END REVIEW -----"
          } > summary_prompt.txt

          cursor-agent -m gpt-4 < summary_prompt.txt >> review.md 2>/dev/null || echo "‚ö†Ô∏è *AI summary unavailable*" >> review.md

      - name: "üí¨ Post Review Comment"
        if: steps.changed-files.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let review = '';

            try {
              review = fs.readFileSync('review.md', 'utf8');
            } catch {
              review = '‚ö†Ô∏è Unable to generate AI review. Please check workflow logs.';
            }

            review += '\n\n---\n';
            review += '*ü§ñ This review was generated by Cursor AI. Please verify all suggestions before implementing.*\n';
            review += '*‚ö° Powered by Cursor AI + GitHub Actions*';

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: review
            });

      - name: "üì§ Upload Review Artifact"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review
          path: review.md
          retention-days: 30
